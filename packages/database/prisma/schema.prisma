datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider   = "prisma-client"
  output     = "./generated"
  engineType = "client"
}

generator zod {
  provider              = "prisma-zod-generator"
  output                = "./zod"
  useDecimalJs          = true
  prismaJsonNullability = true
  createIndexFile       = true
}

model User {
  id                 String       @id @default(cuid())
  name               String
  email              String
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime
  username           String?
  role               String?
  banned             Boolean?
  banReason          String?
  banExpires         DateTime?
  onboardingComplete Boolean      @default(false)
  paymentsCustomerId String?
  locale             String?
  displayUsername    String?
  twoFactorEnabled   Boolean?
  sessions           Session[]
  accounts           Account[]
  passkeys           Passkey[]
  invitations        Invitation[]
  purchases          Purchase[]
  members            Member[]
  twofactors         TwoFactor[]
  aiChats            AiChat[]

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  token     String
  createdAt DateTime
  updatedAt DateTime

  @@unique([token])
  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String   @db.Text
  expiresAt  DateTime

  createdAt DateTime?
  updatedAt DateTime?

  @@map("verification")
}

model Passkey {
  id           String    @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  aaguid       String?
  createdAt    DateTime?

  @@map("passkey")
}

model TwoFactor {
  id          String @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twoFactor")
}

model Organization {
  id                    String                 @id @default(cuid())
  name                  String
  slug                  String?
  logo                  String?
  createdAt             DateTime
  metadata              String?
  paymentsCustomerId    String?
  members               Member[]
  invitations           Invitation[]
  purchases             Purchase[]
  aiChats               AiChat[]
  financialTransactions FinancialTransaction[]
  saasMetrics           SaasMetrics[]
  costTrackings         CostTracking[]
  agentDecisions        AgentDecision[]
  saasProducts          SaasProduct[]
  marketingAdCampaigns  MarketingAdCampaign[]
  marketingContent      MarketingContent[]
  marketingDecisions    MarketingDecision[]
  marketingGuards       MarketingGuard[]
  marketingLeads        MarketingLead[]
  marketingMemories     MarketingMemory[]
  marketingJobs         MarketingJob[]
  autoSaasInbox         AutoSaasInbox[]
  autoSaasOutbox        AutoSaasOutbox[]
  apiUsageLogs          ApiUsageLog[]
  marketingConfig       MarketingConfig?
  financialMetrics      FinancialMetric[]
  transactions          Transaction[]
  financeActions        FinanceAction[]
  predictions           Prediction[]
  anomalies             Anomaly[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([organizationId, userId])
  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

enum PurchaseType {
  SUBSCRIPTION
  ONE_TIME
}

model Purchase {
  id             String        @id @default(cuid())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  type           PurchaseType
  customerId     String
  subscriptionId String?       @unique
  productId      String
  status         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([subscriptionId])
  @@map("purchase")
}

model AiChat {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String?
  /// [ChatMessages]
  messages       Json          @default("[]")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("ai_chat")
}

// ============================================
// FINANCIAL SYSTEM MODELS
// ============================================

enum TransactionType {
  REVENUE
  COST_API_CLAUDE
  COST_API_OPENAI
  COST_STRIPE_FEE
  COST_ADS
}

model FinancialTransaction {
  id             String          @id @default(cuid())
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  type           TransactionType
  amount         Decimal         @db.Decimal(10, 2)
  currency       String          @default("EUR")
  source         String
  metadata       Json?
  createdAt      DateTime        @default(now())

  @@index([organizationId])
  @@index([createdAt])
  @@map("financial_transaction")
}

enum SaasStatus {
  ACTIVE
  PAUSED
  OPTIMIZING
  KILLED
}

model SaasMetrics {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  date            DateTime
  mrr             Decimal      @db.Decimal(10, 2)
  arr             Decimal      @db.Decimal(10, 2)
  totalRevenue    Decimal      @db.Decimal(10, 2)
  totalCosts      Decimal      @db.Decimal(10, 2)
  netProfit       Decimal      @db.Decimal(10, 2)
  roi             Float
  apiCostsMTD     Decimal      @db.Decimal(10, 2)
  adCostsMTD      Decimal      @db.Decimal(10, 2)
  activeCustomers Int
  churnRate       Float
  status          SaasStatus
  updatedAt       DateTime     @updatedAt

  @@unique([organizationId, date])
  @@map("saas_metrics")
}

enum AIProvider {
  CLAUDE_OPUS
  CLAUDE_SONNET
  CLAUDE_HAIKU
  OPENAI_GPT4
  OPENAI_GPT35
}

model CostTracking {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  provider       AIProvider
  requestId      String
  inputTokens    Int
  outputTokens   Int
  totalTokens    Int
  estimatedCost  Decimal      @db.Decimal(10, 6)
  endpoint       String
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([createdAt])
  @@map("cost_tracking")
}

enum Decision {
  SCALE
  MAINTAIN
  OPTIMIZE
  KILL
}

model AgentDecision {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agentType      String
  decision       Decision
  reasoning      String       @db.Text
  metrics        Json
  executed       Boolean      @default(false)
  executedAt     DateTime?
  createdAt      DateTime     @default(now())

  @@map("agent_decision")
}

// ═══════════════════════════════════════════════════════
// INTEGRATION LAYER: Marketing + Finance Attribution
// ═══════════════════════════════════════════════════════

model AttributionEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User Tracking
  userId         String?
  sessionId      String
  visitorId      String // Anonymous tracking
  organizationId String?

  // Event Data
  eventType  String // 'ad_click', 'page_view', 'signup', 'purchase', 'trial_start'
  eventValue Float? // Value in euros for purchase events

  // Attribution Data
  source   String? // 'google_ads', 'meta_ads', 'organic', 'direct', 'referral'
  medium   String? // 'cpc', 'social', 'email', 'organic'
  campaign String? // Campaign name
  adGroup  String? // Ad group name
  keyword  String? // Keyword for search ads
  adId     String? // Specific ad ID

  // Marketing Context
  landingPage String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?

  // Device & Location
  device  String? // 'mobile', 'desktop', 'tablet'
  country String?
  city    String?

  // Metadata
  metadata Json?

  @@index([userId])
  @@index([sessionId])
  @@index([organizationId])
  @@index([eventType])
  @@index([source])
  @@index([campaign])
  @@index([createdAt])
  @@map("attribution_event")
}

model CustomerJourney {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Customer Info
  userId         String  @unique
  organizationId String?
  email          String?

  // Journey Tracking
  firstTouchSource   String? // First interaction source
  firstTouchCampaign String?
  firstTouchDate     DateTime?

  lastTouchSource   String? // Last interaction before conversion
  lastTouchCampaign String?
  lastTouchDate     DateTime?

  // Attribution Model Results
  firstTouchValue Float @default(0) // Revenue attributed to first touch
  lastTouchValue  Float @default(0) // Revenue attributed to last touch
  linearValue     Float @default(0) // Revenue distributed linearly

  // Conversion Data
  hasConverted    Boolean   @default(false)
  conversionDate  DateTime?
  conversionValue Float?
  lifetimeValue   Float     @default(0)

  // Journey Stats
  touchpointsCount Int  @default(0)
  daysToConversion Int?

  // Metadata
  metadata Json?

  @@index([userId])
  @@index([organizationId])
  @@index([firstTouchSource])
  @@index([lastTouchSource])
  @@map("customer_journey")
}

model CampaignPerformance {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Campaign Info
  organizationId String
  campaignId     String // ID from marketing system
  campaignName   String
  source         String // 'google_ads', 'meta_ads', etc.
  status         String // 'active', 'paused', 'completed'

  // Date Range
  startDate DateTime
  endDate   DateTime?

  // Spend Data
  totalSpend      Float  @default(0)
  dailyBudget     Float?
  budgetRemaining Float?

  // Performance Metrics
  impressions Int   @default(0)
  clicks      Int   @default(0)
  conversions Int   @default(0)
  revenue     Float @default(0)

  // Calculated Metrics
  ctr  Float @default(0) // Click-through rate
  cpc  Float @default(0) // Cost per click
  cpa  Float @default(0) // Cost per acquisition
  roas Float @default(0) // Return on ad spend
  roi  Float @default(0) // Return on investment

  // Attribution Data
  firstTouchRevenue Float @default(0)
  lastTouchRevenue  Float @default(0)
  linearRevenue     Float @default(0)

  // Finance Integration
  profitMargin  Float?
  netProfit     Float?
  ltv           Float?
  paybackPeriod Float?

  // AI Recommendations
  recommendedAction String? // 'scale', 'maintain', 'optimize', 'pause'
  recommendedBudget Float?
  confidenceScore   Float?
  lastAnalyzedAt    DateTime?

  // Metadata
  metadata Json?

  @@index([organizationId])
  @@index([campaignId])
  @@index([source])
  @@index([status])
  @@index([startDate])
  @@map("campaign_performance")
}

model BudgetAllocation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Organization
  organizationId String

  // Budget Data
  totalBudget     Float
  allocatedBudget Float @default(0)
  remainingBudget Float

  // Period
  period      String // 'monthly', 'weekly', 'daily'
  periodStart DateTime
  periodEnd   DateTime

  // Channel Allocation
  googleAdsBudget Float @default(0)
  metaAdsBudget   Float @default(0)
  contentBudget   Float @default(0)
  emailBudget     Float @default(0)
  otherBudget     Float @default(0)

  // Performance Tracking
  totalSpent   Float @default(0)
  totalRevenue Float @default(0)
  totalROI     Float @default(0)

  // AI Control
  managedByAI        Boolean   @default(false)
  lastAIAdjustment   DateTime?
  aiAdjustmentReason String?

  // Approval
  requiresApproval Boolean   @default(true)
  approvedBy       String?
  approvedAt       DateTime?

  // Metadata
  metadata Json?

  @@index([organizationId])
  @@index([periodStart])
  @@map("budget_allocation")
}

model IntegrationEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Event Info
  organizationId String
  eventType      String // 'budget_change', 'campaign_scaled', 'alert_sent', 'action_executed'
  sourceSystem   String // 'finance', 'marketing', 'integration'
  targetSystem   String?

  // Event Data
  title       String
  description String
  severity    String // 'info', 'warning', 'critical'

  // Action Taken
  actionType   String? // 'scale_budget', 'pause_campaign', 'send_alert'
  actionStatus String? // 'pending', 'executed', 'failed'
  actionResult String?

  // Related Entities
  campaignId String?
  budgetId   String?

  // Metadata
  metadata Json?

  @@index([organizationId])
  @@index([eventType])
  @@index([sourceSystem])
  @@index([createdAt])
  @@map("integration_event")
}

// ═══════════════════════════════════════════════════════
// MARKETING SYSTEM MODELS
// ═══════════════════════════════════════════════════════

model SaasProduct {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name             String
  description      String?      @db.Text
  targetAudience   String?
  usp              String?
  pricing          Json?
  marketingEnabled Boolean      @default(false)
  autoPublish      Boolean      @default(false) // Publicación automática si pasa guardias
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  campaigns     MarketingAdCampaign[]
  content       MarketingContent[]
  leads         MarketingLead[]
  marketingJobs MarketingJob[]

  @@index([organizationId])
  @@map("saas_product")
}

model MarketingAdCampaign {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: Cascade)
  name           String
  platform       String // 'facebook', 'google', 'linkedin', etc.
  status         String       @default("DRAFT") // DRAFT, ACTIVE, PAUSED, COMPLETED
  budget         Json?
  targeting      Json?
  performance    Json?
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([productId])
  @@index([platform])
  @@index([status])
  @@map("marketing_ad_campaign")
}

model MarketingContent {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: Cascade)
  type           String // 'POST', 'AD', 'EMAIL', etc.
  platform       String // 'facebook', 'google', 'linkedin', 'email', etc.
  title          String?
  content        Json?
  status         String       @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  performance    Json?
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([productId])
  @@index([platform])
  @@index([status])
  @@map("marketing_content")
}

model MarketingDecision {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agentType      String // 'ads', 'content', 'budget', etc.
  decision       Json
  reasoning      String?      @db.Text
  context        Json?
  executedAt     DateTime?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([agentType])
  @@map("marketing_decision")
}

model MarketingGuard {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  guardType      String // 'financial', 'reputation', 'legal'
  metric         String
  threshold      Float
  currentValue   Float
  status         String // 'ok', 'warning', 'critical'
  triggered      Boolean      @default(false)
  action         Json?
  lastCheck      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([guardType])
  @@index([status])
  @@map("marketing_guard")
}

model MarketingLead {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Info del lead
  email   String
  name    String?
  company String?
  phone   String?
  website String?

  // Scoring
  score       Int    @default(0)
  temperature String @default("cold") // cold, warm, hot, qualified
  stage       String @default("new") // new, contacted, qualified, proposal, negotiation, won, lost

  // Source
  source   String? // organic, ads, referral, email, social
  campaign String?
  medium   String?

  // Engagement
  engagementData Json? // { pageViews, emailOpens, clicks, downloads }
  lastActivity   DateTime?

  // AI Analysis
  aiAnalysis Json? // { buyIntent, budget, timeline, painPoints }

  // Assignment
  assignedTo String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  convertedAt DateTime?

  // Relations
  activities MarketingLeadActivity[]

  @@index([organizationId])
  @@index([productId])
  @@index([email])
  @@index([score])
  @@index([temperature])
  @@map("marketing_lead")
}

model MarketingLeadActivity {
  id        String        @id @default(cuid())
  leadId    String
  lead      MarketingLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String // email_sent, email_opened, page_view, form_submit, call, meeting, note
  data      Json?
  createdAt DateTime      @default(now())

  @@index([leadId])
  @@map("marketing_lead_activity")
}

// ============================================
// MARKETINGOS - MODELOS ADICIONALES
// ============================================

model MarketingMemory {
  id             String @id @default(cuid())
  organizationId String

  memoryType String // business_dna, learning, prompt_template
  content    String @db.Text
  embedding  Json? // Vector embedding para búsqueda semántica
  metadata   Json?
  importance Int    @default(5) // 1-10

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([memoryType])
  @@map("marketing_memory")
}

model MarketingJob {
  id             String  @id @default(cuid())
  organizationId String
  productId      String?

  jobType  String // content_generation, image_generation, email_sequence, voice_generation, campaign_optimization
  status   String @default("pending") // pending, running, completed, failed
  priority Int    @default(5) // 1-10

  input  Json // Parámetros del job
  output Json? // Resultado del job
  error  String? @db.Text // Error si falló

  progress    Int @default(0) // 0-100
  attempts    Int @default(0)
  maxAttempts Int @default(3)

  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product      SaasProduct? @relation(fields: [productId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([jobType])
  @@index([scheduledAt])
  @@map("marketing_job")
}

model AutoSaasInbox {
  id             String @id @default(cuid())
  organizationId String

  messageType String // new_product, product_update, feature_request_response
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([processed])
  @@map("auto_saas_inbox")
}

model AutoSaasOutbox {
  id             String @id @default(cuid())
  organizationId String

  messageType String // feature_request, performance_report, optimization_suggestion
  payload     Json
  sent        Boolean   @default(false)
  sentAt      DateTime?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([sent])
  @@map("auto_saas_outbox")
}

model ApiUsageLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiName        String // anthropic, openai, replicate, elevenlabs
  endpoint       String?
  tokens         Int?
  cost           Float?
  metadata       Json?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([apiName])
  @@index([createdAt])
  @@map("api_usage_log")
}

model MarketingConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  isPaused       Boolean      @default(false)
  settings       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("marketing_config")
}

// ==========================================
// FINANZADIOS SCHEMA
// ==========================================

model FinancialMetric {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Métricas principales
  mrr        Float @default(0)
  arr        Float @default(0)
  revenue30d Float @default(0)
  revenue90d Float @default(0)
  profit     Float @default(0)
  costs      Float @default(0)
  churnRate  Float @default(0)
  growthRate Float @default(0)

  // Metadata
  period       String // 'YYYY-MM' format
  calculatedAt DateTime @default(now())

  @@unique([organizationId, period])
  @@index([organizationId])
  @@index([period])
  @@map("financial_metric")
}

model Transaction {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Datos de transacción
  amount      Float
  currency    String  @default("EUR")
  type        String // 'income' | 'expense'
  category    String // 'subscription' | 'one-time' | 'refund' | 'cost' | etc
  description String?

  // Relacionado con clientes (opcional)
  customerId   String?
  customerName String?

  // Metadata
  date     DateTime
  stripeId String?  @unique
  source   String   @default("manual") // 'stripe' | 'manual' | 'import'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([date])
  @@index([type])
  @@map("transaction")
}

model FinanceAction {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Acción
  type   String // 'alert' | 'email' | 'slack' | 'stripe_pricing' | 'notification'
  status String @default("pending") // 'pending' | 'executed' | 'failed'

  // Datos de la acción
  title       String
  description String?
  severity    String? // 'info' | 'warning' | 'critical'
  params      Json? // Parámetros específicos de la acción

  // Resultado
  result Json? // Resultado de la ejecución
  error  String?

  // Metadata
  triggeredBy String    @default("system") // 'system' | 'user' | 'agent'
  executedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@map("finance_action")
}

model Prediction {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Predicción
  metric         String // 'mrr' | 'revenue' | 'churn' | 'runway'
  currentValue   Float
  predictedValue Float
  period         String // 'YYYY-MM' format del periodo predicho
  confidence     Float  @default(0.7) // 0-1

  // Escenarios
  bestCase  Float?
  worstCase Float?

  // Metadata
  model     String   @default("claude-sonnet") // Modelo de IA usado
  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([metric])
  @@index([period])
  @@map("prediction")
}

model Anomaly {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Anomalía
  type     String // 'mrr_drop' | 'churn_spike' | 'payment_failure' | etc
  severity String // 'low' | 'medium' | 'high' | 'critical'

  // Datos
  metric        String // Métrica afectada
  expectedValue Float
  actualValue   Float
  deviation     Float // % de desviación

  // Análisis
  cause          String? // Causa probable identificada por IA
  impact         String? // Impacto financiero estimado
  recommendation String? // Recomendación de acción

  // Metadata
  detectedAt DateTime  @default(now())
  resolvedAt DateTime?
  status     String    @default("active") // 'active' | 'investigating' | 'resolved'

  @@index([organizationId])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
  @@map("anomaly")
}
