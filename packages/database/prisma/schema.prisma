datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider   = "prisma-client"
  output     = "./generated"
  engineType = "client"
}

generator zod {
  provider              = "prisma-zod-generator"
  output                = "./zod"
  useDecimalJs          = true
  prismaJsonNullability = true
  createIndexFile       = true
}

model User {
  id                 String       @id @default(cuid())
  name               String
  email              String
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime
  username           String?
  role               String?
  banned             Boolean?
  banReason          String?
  banExpires         DateTime?
  onboardingComplete Boolean      @default(false)
  paymentsCustomerId String?
  locale             String?
  displayUsername    String?
  twoFactorEnabled   Boolean?
  sessions           Session[]
  accounts           Account[]
  passkeys           Passkey[]
  invitations        Invitation[]
  purchases          Purchase[]
  members            Member[]
  twofactors         TwoFactor[]
  aiChats            AiChat[]

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  token     String
  createdAt DateTime
  updatedAt DateTime

  @@unique([token])
  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String   @db.Text
  expiresAt  DateTime

  createdAt DateTime?
  updatedAt DateTime?

  @@map("verification")
}

model Passkey {
  id           String    @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  aaguid       String?
  createdAt    DateTime?

  @@map("passkey")
}

model TwoFactor {
  id          String @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twoFactor")
}

model Organization {
  id                    String                 @id @default(cuid())
  name                  String
  slug                  String?
  logo                  String?
  createdAt             DateTime
  metadata              String?
  paymentsCustomerId    String?
  members               Member[]
  invitations           Invitation[]
  purchases             Purchase[]
  aiChats               AiChat[]
  saasProducts          SaasProduct[]
  marketingAdCampaigns  MarketingAdCampaign[]
  marketingContent      MarketingContent[]
  marketingDecisions    MarketingDecision[]
  marketingGuards       MarketingGuard[]
  marketingLeads        MarketingLead[]
  marketingMemories     MarketingMemory[]
  marketingJobs         MarketingJob[]
  autoSaasInbox         AutoSaasInbox[]
  autoSaasOutbox        AutoSaasOutbox[]
  apiUsageLogs          ApiUsageLog[]
  marketingConfig       MarketingConfig?
  businessProfile       BusinessProfile?
  mediaLibrary          MediaLibrary[]
  brandPhotos           BrandPhoto[]
  seoConfig             SeoConfig?
  seoKeywords           SeoKeyword[]
  seoIssues             SeoIssue[]
  socialAccounts        SocialAccount[]
  socialComments        SocialComment[]
  socialMessages        SocialMessage[]
  aiConversations       AiConversation[]
  marketingPosts        MarketingPost[]

  // Sistema de contenido ultra personalizado
  businessIdentity      BusinessIdentity?
  targetAudience        TargetAudience?
  products              Product[]
  marketingEvents       MarketingEvent[]
  mediaAssets           MediaAsset[]
  contentStyle          ContentStyle?
  specialDates          SpecialDate[]
  generatedPosts        GeneratedPost[]
  socialConnections     SocialConnection[]
  mediaFiles            MediaFile[]

  @@unique([slug])
  @@map("organization")
}

// ============================================
// PERFIL DE EMPRESA - Info completa del negocio
// ============================================
model BusinessProfile {
  id                String   @id @default(cuid())
  organizationId    String   @unique
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Info b√°sica
  businessName      String
  tagline           String?   // Frase corta que define el negocio
  industry          String    // restaurante, peluqueria, ecommerce, gimnasio, etc.
  description       String    @db.Text
  foundedYear       Int?
  location          String?
  phone             String?
  email             String?
  websiteUrl        String?
  
  // Redes sociales actuales (para analizar)
  instagramUrl      String?
  facebookUrl       String?
  tiktokUrl         String?
  linkedinUrl       String?
  
  // P√∫blico objetivo
  targetAudience    String    @db.Text  // descripci√≥n detallada del cliente ideal
  ageRangeMin       Int?
  ageRangeMax       Int?
  targetGender      String?   // all, male, female
  targetLocations   String[]  // ciudades/regiones donde est√°n sus clientes
  customerPainPoints String?  @db.Text  // problemas que resuelves
  
  // Tono y personalidad de marca
  brandPersonality  String[]  // profesional, cercano, divertido, elegante, rebelde, etc.
  toneOfVoice       String    @db.Text  // descripci√≥n de c√≥mo habla la marca
  useEmojis         Boolean   @default(true)
  emojiStyle        String    @default("moderate") // none, minimal, moderate, heavy
  wordsToUse        String[]  // palabras que S√ç usar
  wordsToAvoid      String[]  // palabras que NUNCA usar
  hashtagsToUse     String[]  // hashtags de marca
  
  // Productos y servicios
  mainProducts      Json?     // array de {name, description, price, imageUrl}
  services          Json?     // array de {name, description, price}
  priceRange        String?   // bajo, medio, alto, premium
  uniqueSellingPoint String?  @db.Text  // qu√© te hace diferente
  
  // Competencia
  competitors       Json?     // array de {name, instagramUrl, notes}
  
  // Objetivos
  marketingGoals    String[]  // m√°s ventas, m√°s seguidores, m√°s engagement, brand awareness
  monthlyBudget     Float?    // presupuesto mensual en marketing
  
  // Contenido preferido
  contentPreferences Json?    // {preferredTypes: [], postingFrequency: "daily", bestTimes: []}
  
  // Estado
  isComplete        Boolean   @default(false)
  completedSteps    String[]  // ["basic", "audience", "tone", "products", "goals"]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("business_profile")
}

// ============================================
// BANCO DE FOTOS - Media library del negocio
// ============================================
model MediaLibrary {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Info del archivo
  fileName        String
  fileUrl         String    // URL en storage (S3, Cloudflare, etc.)
  fileType        String    // image/jpeg, image/png, video/mp4
  fileSize        Int       // en bytes
  width           Int?
  height          Int?
  
  // Organizaci√≥n
  category        String    // products, team, location, customers, behind-scenes, lifestyle, other
  tags            String[]  // tags para buscar
  altText         String?   // texto alternativo (SEO + accesibilidad)
  description     String?
  
  // IA
  aiTags          String[]  // tags generados por IA
  aiDescription   String?   // descripci√≥n generada por IA
  isAiGenerated   Boolean   @default(false)  // si fue generada con IA
  aiPrompt        String?   @db.Text  // prompt usado para generar
  
  // Uso
  usageCount      Int       @default(0)  // cu√°ntas veces se ha usado
  lastUsedAt      DateTime?
  isFavorite      Boolean   @default(false)
  
  // Metadata
  uploadedBy      String?   // userId
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([organizationId, category])
  @@index([organizationId, tags])
  @@map("media_library")
}

// ============================================
// SEO CONFIG - Configuraci√≥n de SEO del sitio
// ============================================
model SeoConfig {
  id              String   @id @default(cuid())
  organizationId  String   @unique
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Sitio web
  websiteUrl      String
  sitemapUrl      String?
  
  // Estado del an√°lisis
  lastScanAt      DateTime?
  seoScore        Int?      // 0-100
  
  // Configuraci√≥n
  targetKeywords  String[]  // keywords principales
  competitors     String[]  // URLs de competidores para comparar
  
  // Plataforma del cliente
  platform        String?   // wordpress, wix, shopify, squarespace, html, other
  platformVersion String?
  
  // Resultados del scan
  scanResults     Json?     // {issues: [], opportunities: [], scores: {}}
  
  // Relaciones
  issues          SeoIssue[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("seo_config")
}

// ============================================
// SEO ISSUES - Problemas detectados con soluciones
// ============================================
model SeoIssue {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  seoConfigId     String
  seoConfig       SeoConfig @relation(fields: [seoConfigId], references: [id], onDelete: Cascade)
  
  // Problema detectado
  type            String    // meta-description, images, speed, headings, alt-text, etc.
  severity        String    // critical, warning, info
  title           String
  description     String    @db.Text
  
  // P√°ginas afectadas
  affectedUrls    String[]
  affectedCount   Int
  
  // Impacto estimado
  impactScore     Int       // 1-100
  impactDescription String?
  
  // Soluci√≥n generada
  solution        String?   @db.Text  // Explicaci√≥n
  solutionCode    String?   @db.Text  // C√≥digo a copiar
  solutionSteps   Json?     // Pasos detallados [{step, description, image?, video?}]
  
  // Estado
  status          String    @default("pending") // pending, in_progress, fixed, ignored
  fixedAt         DateTime?
  verifiedAt      DateTime?
  
  // Plataforma espec√≠fica
  platformGuide   Json?     // {wordpress: [...], wix: [...], shopify: [...], html: [...]}
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([organizationId, status])
  @@index([seoConfigId])
  @@map("seo_issue")
}

// ============================================
// SEO KEYWORDS - Tracking de keywords
// ============================================
model SeoKeyword {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  keyword         String
  currentPosition Int?      // posici√≥n en Google
  previousPosition Int?
  searchVolume    Int?      // b√∫squedas mensuales
  difficulty      Int?      // 0-100
  
  // Historial
  positionHistory Json?     // [{date, position}]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([organizationId, keyword])
  @@map("seo_keyword")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([organizationId, userId])
  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

enum PurchaseType {
  SUBSCRIPTION
  ONE_TIME
}

model Purchase {
  id             String        @id @default(cuid())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  type           PurchaseType
  customerId     String
  subscriptionId String?       @unique
  productId      String
  status         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([subscriptionId])
  @@map("purchase")
}

model AiChat {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String?
  /// [ChatMessages]
  messages       Json          @default("[]")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("ai_chat")
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTEGRATION LAYER: Marketing + Finance Attribution
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

model AttributionEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User Tracking
  userId         String?
  sessionId      String
  visitorId      String // Anonymous tracking
  organizationId String?

  // Event Data
  eventType  String // 'ad_click', 'page_view', 'signup', 'purchase', 'trial_start'
  eventValue Float? // Value in euros for purchase events

  // Attribution Data
  source   String? // 'google_ads', 'meta_ads', 'organic', 'direct', 'referral'
  medium   String? // 'cpc', 'social', 'email', 'organic'
  campaign String? // Campaign name
  adGroup  String? // Ad group name
  keyword  String? // Keyword for search ads
  adId     String? // Specific ad ID

  // Marketing Context
  landingPage String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?

  // Device & Location
  device  String? // 'mobile', 'desktop', 'tablet'
  country String?
  city    String?

  // Metadata
  metadata Json?

  @@index([userId])
  @@index([sessionId])
  @@index([organizationId])
  @@index([eventType])
  @@index([source])
  @@index([campaign])
  @@index([createdAt])
  @@map("attribution_event")
}

model CustomerJourney {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Customer Info
  userId         String  @unique
  organizationId String?
  email          String?

  // Journey Tracking
  firstTouchSource   String? // First interaction source
  firstTouchCampaign String?
  firstTouchDate     DateTime?

  lastTouchSource   String? // Last interaction before conversion
  lastTouchCampaign String?
  lastTouchDate     DateTime?

  // Attribution Model Results
  firstTouchValue Float @default(0) // Revenue attributed to first touch
  lastTouchValue  Float @default(0) // Revenue attributed to last touch
  linearValue     Float @default(0) // Revenue distributed linearly

  // Conversion Data
  hasConverted    Boolean   @default(false)
  conversionDate  DateTime?
  conversionValue Float?
  lifetimeValue   Float     @default(0)

  // Journey Stats
  touchpointsCount Int  @default(0)
  daysToConversion Int?

  // Metadata
  metadata Json?

  @@index([userId])
  @@index([organizationId])
  @@index([firstTouchSource])
  @@index([lastTouchSource])
  @@map("customer_journey")
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKETING SYSTEM MODELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

model SaasProduct {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name             String
  description      String?      @db.Text
  targetAudience   String?
  usp              String?
  pricing          Json?
  marketingEnabled Boolean      @default(false)
  autoPublish      Boolean      @default(false) // Publicaci√≥n autom√°tica si pasa guardias
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  campaigns     MarketingAdCampaign[]
  content       MarketingContent[]
  leads         MarketingLead[]
  marketingJobs MarketingJob[]

  @@index([organizationId])
  @@map("saas_product")
}

model MarketingAdCampaign {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: Cascade)
  name           String
  platform       String // 'facebook', 'google', 'linkedin', etc.
  status         String       @default("DRAFT") // DRAFT, ACTIVE, PAUSED, COMPLETED
  budget         Json?
  targeting      Json?
  performance    Json?
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([productId])
  @@index([platform])
  @@index([status])
  @@map("marketing_ad_campaign")
}

model MarketingContent {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: Cascade)
  type           String // 'POST', 'AD', 'EMAIL', etc.
  platform       String // 'facebook', 'google', 'linkedin', 'email', etc.
  title          String?
  content        Json?
  status         String       @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  performance    Json?
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([productId])
  @@index([platform])
  @@index([status])
  @@map("marketing_content")
}

model MarketingDecision {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agentType      String // 'ads', 'content', 'budget', etc.
  decision       Json
  reasoning      String?      @db.Text
  context        Json?
  executedAt     DateTime?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([agentType])
  @@map("marketing_decision")
}

model MarketingGuard {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  guardType      String // 'financial', 'reputation', 'legal'
  metric         String
  threshold      Float
  currentValue   Float
  status         String // 'ok', 'warning', 'critical'
  triggered      Boolean      @default(false)
  action         Json?
  lastCheck      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([guardType])
  @@index([status])
  @@map("marketing_guard")
}

model MarketingLead {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Info del lead
  email   String
  name    String?
  company String?
  phone   String?
  website String?

  // Scoring
  score       Int    @default(0)
  temperature String @default("cold") // cold, warm, hot, qualified
  stage       String @default("new") // new, contacted, qualified, proposal, negotiation, won, lost

  // Source
  source   String? // organic, ads, referral, email, social
  campaign String?
  medium   String?

  // Engagement
  engagementData Json? // { pageViews, emailOpens, clicks, downloads }
  lastActivity   DateTime?

  // AI Analysis
  aiAnalysis Json? // { buyIntent, budget, timeline, painPoints }

  // Assignment
  assignedTo String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  convertedAt DateTime?

  // Relations
  activities MarketingLeadActivity[]

  @@index([organizationId])
  @@index([productId])
  @@index([email])
  @@index([score])
  @@index([temperature])
  @@map("marketing_lead")
}

model MarketingLeadActivity {
  id        String        @id @default(cuid())
  leadId    String
  lead      MarketingLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String // email_sent, email_opened, page_view, form_submit, call, meeting, note
  data      Json?
  createdAt DateTime      @default(now())

  @@index([leadId])
  @@map("marketing_lead_activity")
}

// ============================================
// MARKETINGOS - MODELOS ADICIONALES
// ============================================

model MarketingMemory {
  id             String @id @default(cuid())
  organizationId String

  memoryType String // business_dna, learning, prompt_template
  content    String @db.Text
  embedding  Json? // Vector embedding para b√∫squeda sem√°ntica
  metadata   Json?
  importance Int    @default(5) // 1-10

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([memoryType])
  @@map("marketing_memory")
}

model MarketingJob {
  id             String  @id @default(cuid())
  organizationId String
  productId      String?

  jobType  String // content_generation, image_generation, email_sequence, voice_generation, campaign_optimization
  status   String @default("pending") // pending, running, completed, failed
  priority Int    @default(5) // 1-10

  input  Json // Par√°metros del job
  output Json? // Resultado del job
  error  String? @db.Text // Error si fall√≥

  progress    Int @default(0) // 0-100
  attempts    Int @default(0)
  maxAttempts Int @default(3)

  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product      SaasProduct? @relation(fields: [productId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([jobType])
  @@index([scheduledAt])
  @@map("marketing_job")
}

model AutoSaasInbox {
  id             String @id @default(cuid())
  organizationId String

  messageType String // new_product, product_update, feature_request_response
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([processed])
  @@map("auto_saas_inbox")
}

model AutoSaasOutbox {
  id             String @id @default(cuid())
  organizationId String

  messageType String // feature_request, performance_report, optimization_suggestion
  payload     Json
  sent        Boolean   @default(false)
  sentAt      DateTime?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([sent])
  @@map("auto_saas_outbox")
}

model ApiUsageLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiName        String // anthropic, openai, replicate, elevenlabs
  endpoint       String?
  tokens         Int?
  cost           Float?
  metadata       Json?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([apiName])
  @@index([createdAt])
  @@map("api_usage_log")
}

model MarketingConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  isPaused       Boolean      @default(false)
  settings       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("marketing_config")
}

model CronLog {
  id          String   @id @default(cuid())
  jobName     String
  status      String   // running, completed, failed
  results     String?  @db.Text
  error       String?  @db.Text
  executedAt  DateTime @default(now())
  duration    Int?     // milliseconds

  @@index([jobName, executedAt])
  @@map("cron_log")
}


// ============================================
// SOCIAL ACCOUNTS - MULTITENANT SYSTEM
// ============================================

model SocialAccount {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  platform       String   // 'instagram', 'facebook', 'tiktok', 'linkedin', 'twitter'
  accountId      String   // ID de la cuenta en la plataforma
  accountName    String   // @username o nombre visible
  avatarUrl      String?  // Foto de perfil
  
  accessToken    String   // Token de acceso (TODO: encriptar)
  refreshToken   String?  // Para plataformas que lo usan
  tokenExpiresAt DateTime? // Cu√°ndo expira el token
  
  // Metadata espec√≠fica de plataforma
  pageId         String?  // Facebook Page ID
  businessId     String?  // Instagram Business Account ID
  
  isActive       Boolean  @default(true)
  lastSyncAt     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([organizationId, platform, accountId])
  @@index([organizationId])
  @@index([platform])
  @@index([isActive])
  @@map("social_account")
}

// ============================================
// AI CONVERSATIONS - Chat con asistente de marketing
// ============================================
model AiConversation {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId          String
  
  title           String?   // auto-generado del primer mensaje
  
  messages        AiMessage[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([organizationId, userId])
  @@map("ai_conversation")
}

model AiMessage {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    AiConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role            String    // "user" | "assistant"
  content         String    @db.Text
  
  // Si el mensaje gener√≥ contenido
  generatedContent Json?    // {type: "post", platform: "instagram", content: "...", imageUrl: "..."}
  
  createdAt       DateTime  @default(now())
  
  @@index([conversationId])
  @@map("ai_message")
}

// ============================================
// MARKETING POSTS - Posts de redes sociales
// ============================================
model MarketingPost {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Contenido
  content         String    @db.Text
  contentHtml     String?   @db.Text  // versi√≥n con formato
  
  // Media
  mediaUrls       String[]  // URLs de im√°genes/videos
  mediaLibraryIds String[]  // Referencias al banco de fotos
  
  // Plataforma y tipo
  platform        String    // instagram, facebook, tiktok, linkedin, twitter
  postType        String    // feed, story, reel, carousel
  
  // Metadata
  hashtags        String[]
  mentions        String[]
  link            String?
  callToAction    String?
  
  // Estado y programaci√≥n
  status          String    @default("draft") // draft, scheduled, publishing, published, failed
  scheduledAt     DateTime?
  publishedAt     DateTime?
  
  // Resultado de publicaci√≥n
  externalId      String?   // ID del post en la plataforma
  externalUrl     String?   // URL del post publicado
  publishError    String?
  
  // Analytics
  impressions     Int       @default(0)
  reach           Int       @default(0)
  likes           Int       @default(0)
  comments        Int       @default(0)
  shares          Int       @default(0)
  saves           Int       @default(0)
  clicks          Int       @default(0)
  
  // IA
  aiGenerated     Boolean   @default(false)
  aiPrompt        String?   @db.Text  // prompt usado para generar
  
  createdBy       String?   // userId
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([organizationId, status])
  @@index([organizationId, platform])
  @@index([organizationId, scheduledAt])
  @@map("marketing_post")
}

// ============================================
// SOCIAL COMMENTS - Comentarios de redes sociales
// ============================================
model SocialComment {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Origen
  platform        String    // instagram, facebook, tiktok
  externalId      String    // ID en la plataforma
  postExternalId  String?   // ID del post al que pertenece
  
  // Contenido
  authorName      String
  authorUsername  String?
  authorAvatar    String?
  content         String    @db.Text
  
  // An√°lisis
  sentiment       String?   // positive, neutral, negative
  category        String?   // question, complaint, praise, spam
  needsReply      Boolean   @default(true)
  
  // Respuesta
  replied         Boolean   @default(false)
  replyContent    String?   @db.Text
  repliedAt       DateTime?
  repliedBy       String?   // userId o "ai"
  
  // Estado
  isHidden        Boolean   @default(false)
  isSpam          Boolean   @default(false)
  
  commentedAt     DateTime
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([platform, externalId])
  @@index([organizationId, platform])
  @@index([organizationId, needsReply])
  @@map("social_comment")
}

// ============================================
// SOCIAL MESSAGES - Mensajes directos de redes sociales
// ============================================
model SocialMessage {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  platform        String
  externalId      String
  threadId        String?
  
  // Participantes
  senderName      String
  senderUsername  String?
  senderAvatar    String?
  isFromBusiness  Boolean   @default(false)
  
  // Contenido
  content         String    @db.Text
  mediaUrls       String[]
  
  // Estado
  isRead          Boolean   @default(false)
  needsReply      Boolean   @default(true)
  
  sentAt          DateTime
  createdAt       DateTime  @default(now())
  
  @@unique([platform, externalId])
  @@index([organizationId, threadId])
  @@map("social_message")
}

model BrandPhoto {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  url             String   // URL de la imagen (Cloudinary/S3/etc)
  thumbnailUrl    String?  // Versi√≥n peque√±a para preview
  
  // Categorizaci√≥n para b√∫squeda inteligente
  category        String   // "product", "team", "location", "process", "lifestyle", "event"
  tags            String[] // ["panader√≠a", "croissant", "horneando", "producto"]
  description     String?  // "Nuestro croissant reci√©n horneado"
  
  // Metadata
  width           Int?
  height          Int?
  
  // Para que la IA sepa cu√°ndo usarla
  useFor          String[] // ["promotional", "educational", "behind-scenes"]
  mood            String?  // "profesional", "casual", "divertido", "elegante"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([organizationId])
  @@index([category])
  @@map("brand_photo")
}

// ==========================================
// SISTEMA DE CONTENIDO ULTRA PERSONALIZADO
// ==========================================

// Perfil de negocio extendido
model BusinessIdentity {
  id              String   @id @default(cuid())
  organizationId  String   @unique
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Identidad b√°sica
  businessName    String?
  slogan          String?
  shortDescription String?  @db.Text  // Descripci√≥n corta para posts
  longDescription String?   @db.Text  // Historia completa
  
  // Qu√© te hace √∫nico
  uniqueValue     String?   @db.Text  // Propuesta de valor √∫nica
  competitorDiff  String?   @db.Text  // Qu√© te diferencia de la competencia
  
  // Personalidad de marca
  brandPersonality String?  // "cercano", "profesional", "divertido", "tradicional", "moderno", "premium"
  brandValues     String[]  // ["calidad", "tradici√≥n", "innovaci√≥n", "sostenibilidad"]
  
  // Origen e historia
  foundingYear    Int?
  foundingStory   String?   @db.Text  // Historia de c√≥mo empez√≥
  ownerName       String?
  ownerStory      String?   @db.Text  // Historia personal del due√±o
  
  // Ubicaci√≥n
  city            String?
  neighborhood    String?
  fullAddress     String?
  googleMapsUrl   String?
  
  // Contacto
  phone           String?
  whatsapp        String?
  email           String?
  website         String?
  
  // Horarios
  schedule        Json?     // { "monday": "8:00-20:00", "tuesday": "8:00-20:00", ... }
  
  // Industria
  industry        String?   // "panaderia", "barberia", "restaurante", "tienda", "servicios"
  subIndustry     String?   // "panaderia artesanal", "barberia moderna", etc.
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("business_identity")
}

// Audiencia objetivo
model TargetAudience {
  id              String   @id @default(cuid())
  organizationId  String   @unique
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Demograf√≠a
  ageRangeMin     Int?      @default(18)
  ageRangeMax     Int?      @default(65)
  gender          String?   // "all", "male", "female"
  
  // Ubicaci√≥n
  targetLocations String[]  // ["Barcelona", "Gracia", "Sant Gervasi"]
  
  // Perfil del cliente ideal
  idealCustomer   String?   @db.Text  // Descripci√≥n del cliente ideal
  customerPains   String[]  // Problemas que tienen
  customerDesires String[]  // Qu√© desean conseguir
  
  // Intereses
  interests       String[]  // ["gastronom√≠a", "productos locales", "artesanal"]
  
  // Comportamiento
  buyingFrequency String?   // "diario", "semanal", "mensual", "ocasional"
  averageTicket   Float?    // Ticket medio en euros
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("target_audience")
}

// Cat√°logo de productos/servicios
model Product {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Informaci√≥n b√°sica
  name            String
  shortDescription String?  // Para posts (max 100 chars)
  longDescription String?   @db.Text  // Descripci√≥n detallada
  
  // Categorizaci√≥n
  category        String?   // "panes", "dulces", "bebidas", "cortes", "servicios"
  subcategory     String?   // "pan artesanal", "croissants", "tartas"
  
  // Precios
  price           Float?
  priceRange      String?   // "‚Ç¨", "‚Ç¨‚Ç¨", "‚Ç¨‚Ç¨‚Ç¨" para cuando no quieres mostrar precio exacto
  
  // Caracter√≠sticas
  ingredients     String[]  // ["harina ecol√≥gica", "masa madre", "sin conservantes"]
  features        String[]  // ["vegano", "sin gluten", "artesanal", "edici√≥n limitada"]
  
  // Estados especiales
  isBestseller    Boolean   @default(false)
  isNew           Boolean   @default(false)
  isSeasonal      Boolean   @default(false)
  isLimitedEdition Boolean  @default(false)
  isPromo         Boolean   @default(false)
  
  // Disponibilidad
  availability    String?   // "siempre", "fines de semana", "por encargo", "temporada"
  seasonStart     String?   // "marzo"
  seasonEnd       String?   // "mayo"
  
  // Media
  mainImageUrl    String?
  images          String[]  // URLs adicionales
  
  // Para contenido
  promotionHook   String?   // Frase gancho para promocionar este producto
  hashtags        String[]  // Hashtags espec√≠ficos para este producto
  
  // Orden y visibilidad
  displayOrder    Int       @default(0)
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([organizationId])
  @@map("product")
}

// Eventos y promociones
model MarketingEvent {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Tipo de evento
  eventType       String    // "sorteo", "descuento", "lanzamiento", "evento", "colaboracion", "aniversario"
  
  // Informaci√≥n b√°sica
  title           String
  description     String?   @db.Text
  
  // Fechas
  startDate       DateTime
  endDate         DateTime?
  
  // Para sorteos
  prize           String?   // "Tarta de cumplea√±os gratis"
  rules           String[]  // ["Seguir cuenta", "Comentar mencionando 2 amigos", "Compartir en stories"]
  winnersCount    Int?      @default(1)
  
  // Para descuentos
  discountType    String?   // "porcentaje", "fijo", "2x1", "envio gratis"
  discountValue   Float?    // 20 (para 20% o 20‚Ç¨)
  discountCode    String?   // "VERANO20"
  
  // Para lanzamientos
  productId       String?   // Producto que se lanza
  
  // Contenido generado
  announcementPost String?  @db.Text  // Post de anuncio
  reminderPosts    String[] // Posts de recordatorio
  winnerPost       String?  @db.Text  // Post de ganador (para sorteos)
  
  // Estado
  status          String    @default("draft") // "draft", "active", "ended", "cancelled"
  
  // Media
  imageUrl        String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([organizationId])
  @@index([eventType])
  @@index([status])
  @@map("marketing_event")
}

// Banco de fotos categorizado
model MediaAsset {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Archivo
  url             String
  thumbnailUrl    String?
  fileName        String?
  fileSize        Int?
  mimeType        String?
  
  // Categorizaci√≥n
  category        String    // "local", "productos", "equipo", "proceso", "clientes", "eventos", "general"
  subcategory     String?   // "interior", "exterior", "ambiente", "detalle"
  
  // Descripci√≥n
  title           String?
  description     String?
  altText         String?   // Para accesibilidad y SEO
  
  // Tags para b√∫squeda
  tags            String[]
  
  // Productos relacionados
  productIds      String[]  // IDs de productos que aparecen en la foto
  
  // Metadatos
  takenAt         DateTime? // Cu√°ndo se tom√≥ la foto
  location        String?   // D√≥nde se tom√≥
  
  // Uso
  usageCount      Int       @default(0)  // Veces que se ha usado en posts
  lastUsedAt      DateTime?
  
  // Estado
  isFavorite      Boolean   @default(false)
  isApproved      Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([organizationId])
  @@index([category])
  @@map("media_asset")
}

// Configuraci√≥n de tono y estilo de contenido
model ContentStyle {
  id              String   @id @default(cuid())
  organizationId  String   @unique
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Tono general
  formalityLevel  Int       @default(3)  // 1=muy informal, 5=muy formal
  humorLevel      Int       @default(3)  // 1=serio, 5=muy divertido
  
  // Emojis
  emojiUsage      String    @default("moderate") // "none", "minimal", "moderate", "heavy"
  favoriteEmojis  String[]  // ["ü•ê", "‚ù§Ô∏è", "‚ú®"]
  
  // Idioma
  language        String    @default("es")
  dialect         String?   // "es-ES", "es-MX", "es-AR"
  useLocalSlang   Boolean   @default(false)
  
  // Frases caracter√≠sticas
  signaturePhrases String[] // Frases que siempre usas
  bannedWords      String[] // Palabras que NUNCA usar√≠as
  
  // CTAs favoritos
  favoriteCTAs    String[]  // ["¬°Te esperamos!", "Reserva ya", "Link en bio"]
  
  // Hashtags fijos
  fixedHashtags   String[]  // Hashtags que siempre incluyes
  
  // Menciones fijas
  alwaysMention   String[]  // Cuentas que siempre mencionas
  
  // Estructura de posts
  preferredLength String    @default("medium") // "short", "medium", "long"
  useLineBreaks   Boolean   @default(true)
  useBulletPoints Boolean   @default(false)
  
  // Horarios preferidos de publicaci√≥n
  preferredTimes  Json?     // { "monday": ["10:00", "18:00"], ... }
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("content_style")
}

// Plantillas de contenido por industria
model ContentTemplate {
  id              String   @id @default(cuid())
  
  // Categorizaci√≥n
  industry        String    // "panaderia", "barberia", "restaurante", etc.
  contentType     String    // "promocion", "educativo", "engagement", "behind_scenes", "testimonio", "sorteo"
  platform        String    // "instagram", "facebook", "tiktok", "stories"
  
  // Plantilla
  name            String
  description     String?
  
  // Template con variables
  template        String    @db.Text  // "¬°Buenos d√≠as! ü•ê Hoy tenemos {{producto}} reci√©n salido del horno..."
  
  // Variables disponibles
  variables       String[]  // ["producto", "precio", "ubicacion", "horario"]
  
  // Ejemplo
  example         String?   @db.Text
  
  // Metadatos
  isActive        Boolean   @default(true)
  usageCount      Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([industry])
  @@index([contentType])
  @@index([platform])
  @@map("content_template")
}

// Calendario de fechas especiales
model SpecialDate {
  id              String   @id @default(cuid())
  organizationId  String?  // null = fecha global, con ID = fecha espec√≠fica del negocio
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Fecha
  date            DateTime? // Fecha fija (ej: 14 de febrero)
  dayOfYear       Int?      // D√≠a del a√±o (1-365) para fechas que cambian
  recurrence      String?   // "yearly", "monthly", "once"
  
  // Informaci√≥n
  name            String    // "San Valent√≠n", "D√≠a del Pan", "Aniversario"
  description     String?
  
  // Industrias relevantes
  industries      String[]  // ["panaderia", "restaurante"] o ["all"]
  
  // Sugerencias de contenido
  contentSuggestions String[] // Ideas de posts para ese d√≠a
  
  // Importancia
  importance      Int       @default(3)  // 1-5, para priorizar
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([organizationId])
  @@map("special_date")
}

// ============================================
// GENERATED POSTS - Posts generados por IA
// ============================================
model GeneratedPost {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Contenido
  mainText        String   @db.Text
  hashtags        String[] @default([])
  suggestedCTA    String?
  alternativeText String?  @db.Text

  // Metadata
  contentType     String   // producto, engagement, social_proof, etc.
  platform        String   // instagram, facebook, stories

  // Imagen
  selectedImageUrl String?
  imagePrompt      String?

  // Estado
  status          String   @default("draft") // draft, scheduled, published, failed
  scheduledAt     DateTime?
  publishedAt     DateTime?

  // Producto/Evento relacionado (opcional)
  productId       String?
  eventId         String?

  // Resultados (despu√©s de publicar)
  externalPostId  String?  // ID del post en Instagram/Facebook
  likes           Int?
  comments        Int?
  shares          Int?
  reach           Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([organizationId, scheduledAt])
  @@index([status, scheduledAt])
  @@map("generated_post")
}

// ============================================
// SOCIAL CONNECTIONS - OAuth & API tokens
// ============================================
model SocialConnection {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Plataforma
  platform        String   // instagram, facebook, tiktok
  platformUserId  String   // ID del usuario en la plataforma
  platformUsername String?  // @username

  // Tokens (encriptados en producci√≥n)
  accessToken     String   @db.Text
  refreshToken    String?  @db.Text
  tokenExpiresAt  DateTime?

  // Metadata
  profilePictureUrl String?
  followersCount    Int?
  isActive          Boolean @default(true)

  // Permisos concedidos
  permissions       String[] @default([])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, platform, platformUserId])
  @@index([organizationId])
  @@index([platform])
  @@map("social_connection")
}

// ============================================
// MEDIA FILES - Banco de fotos
// ============================================
model MediaFile {
  id              String   @id @default(cuid())
  organizationId  String

  // Archivo
  filename        String
  originalName    String
  mimeType        String
  size            Int      // bytes

  // URLs
  url             String   @db.Text
  thumbnailUrl    String?  @db.Text

  // Metadata
  width           Int?
  height          Int?

  // Organizaci√≥n
  folder          String?  // carpeta virtual
  tags            String[] @default([])
  altText         String?

  // Estado
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, folder])
  @@map("media_file")
}
